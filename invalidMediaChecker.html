<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å®¢èªèªè­‰è©å½™ç„¡æ•ˆéŸ³æª”æª¢æŸ¥å™¨</title>
    <!-- è¼‰å…¥æ‰€æœ‰è©å½™è³‡æ–™ JS æª”æ¡ˆ -->
    <script src="113å››åŸº.js"></script>
    <script src="113å››åˆ.js"></script>
    <script src="113å››ä¸­.js"></script>
    <script src="113å››ä¸­é«˜.js"></script>
    <script src="113å››é«˜.js"></script>
    <script src="113æµ·åŸº.js"></script>
    <script src="113æµ·åˆ.js"></script>
    <script src="113æµ·ä¸­.js"></script>
    <script src="113æµ·ä¸­é«˜.js"></script>
    <script src="113å¤§åŸº.js"></script>
    <script src="113å¤§åˆ.js"></script>
    <script src="113å¤§ä¸­.js"></script>
    <script src="113å¹³åŸº.js"></script>
    <script src="113å®‰åŸº.js"></script>
    <!-- è¼‰å…¥ä¾‹å¤–éŸ³æª”è¨­å®š -->
    <script src="exclusions.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; margin: 20px; line-height: 1.6; }
        h1 { color: #333; }
        p { color: #555; }
        button {
            background-color: #007bff; color: white; border: none;
            padding: 10px 15px; font-size: 16px; border-radius: 5px;
            cursor: pointer; transition: background-color 0.3s ease;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 15px; font-weight: bold; }
        #results {
            margin-top: 15px; border: 1px solid #ddd; padding: 15px;
            height: 500px; overflow-y: scroll; white-space: pre-wrap;
            font-family: "Courier New", Courier, monospace; font-size: 14px;
            background-color: #f9f9f9; border-radius: 5px;
        }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .success { color: #28a745; }
        .item-info { margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>å®¢èªèªè­‰è©å½™ç„¡æ•ˆéŸ³æª”æª¢æŸ¥å™¨</h1>
    <p>é€™æ”¯å·¥å…·æœƒæª¢æŸ¥æ‰€æœ‰è…”èª¿ã€ç´šåˆ¥ã€é¡åˆ¥è©å½™çš„éŸ³æª”ï¼Œçœ‹æ•¢æœ‰å¤±æ•ˆ (ä¾‹å¦‚ 404 éŒ¯èª¤) æˆ–å›  CORS è¨­å®šè€Œç„¡æ³•å­˜å–çš„é€£çµã€‚</p>
    <p><strong>æ³¨æ„ï¼š</strong>æª¢æŸ¥éç¨‹å¯èƒ½æœƒèŠ±å…œæ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…ã€‚çµæœæœƒé¡¯ç¤ºåœ¨ä¸‹æ–¹ã€‚</p>
    <button id="startButton">é–‹å§‹æª¢æŸ¥</button>
    <div id="status">ç‹€æ…‹ï¼šé‚„æœªé–‹å§‹</div>
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        const statusDiv = document.getElementById('status');
        const startButton = document.getElementById('startButton');

        // å¾ index.html æ•´ç†å‡ºä¾†çš„è…”èª¿ç´šåˆ¥è³‡æ–™
        const DIALECT_LEVELS = [
            { name: "å››ç¸£åŸºç¤ç´š", varName: "å››åŸº", data: typeof å››åŸº !== 'undefined' ? å››åŸº : null },
            { name: "å››ç¸£åˆç´š",   varName: "å››åˆ", data: typeof å››åˆ !== 'undefined' ? å››åˆ : null },
            { name: "å››ç¸£ä¸­ç´š",   varName: "å››ä¸­", data: typeof å››ä¸­ !== 'undefined' ? å››ä¸­ : null },
            { name: "å››ç¸£ä¸­é«˜ç´š", varName: "å››ä¸­é«˜", data: typeof å››ä¸­é«˜ !== 'undefined' ? å››ä¸­é«˜ : null },
            { name: "å››ç¸£é«˜ç´š",   varName: "å››é«˜", data: typeof å››é«˜ !== 'undefined' ? å››é«˜ : null },
            { name: "æµ·é™¸åŸºç¤ç´š", varName: "æµ·åŸº", data: typeof æµ·åŸº !== 'undefined' ? æµ·åŸº : null },
            { name: "æµ·é™¸åˆç´š",   varName: "æµ·åˆ", data: typeof æµ·åˆ !== 'undefined' ? æµ·åˆ : null },
            { name: "æµ·é™¸ä¸­ç´š",   varName: "æµ·ä¸­", data: typeof æµ·ä¸­ !== 'undefined' ? æµ·ä¸­ : null },
            { name: "æµ·é™¸ä¸­é«˜ç´š", varName: "æµ·ä¸­é«˜", data: typeof æµ·ä¸­é«˜ !== 'undefined' ? æµ·ä¸­é«˜ : null },
            { name: "å¤§åŸ”åŸºç¤ç´š", varName: "å¤§åŸº", data: typeof å¤§åŸº !== 'undefined' ? å¤§åŸº : null },
            { name: "å¤§åŸ”åˆç´š",   varName: "å¤§åˆ", data: typeof å¤§åˆ !== 'undefined' ? å¤§åˆ : null },
            { name: "å¤§åŸ”ä¸­ç´š",   varName: "å¤§ä¸­", data: typeof å¤§ä¸­ !== 'undefined' ? å¤§ä¸­ : null },
            { name: "é¥’å¹³åŸºç¤ç´š", varName: "å¹³åŸº", data: typeof å¹³åŸº !== 'undefined' ? å¹³åŸº : null },
            { name: "è©”å®‰åŸºç¤ç´š", varName: "å®‰åŸº", data: typeof å®‰åŸº !== 'undefined' ? å®‰åŸº : null }
        ];

        // å¾ index.html æ•´ç†å‡ºä¾†çš„åˆ†é¡
        const CATEGORIES = [
            "äººé«”èˆ‡é†«ç™‚", "å¿ƒç†æ´»å‹•èˆ‡æ„Ÿè¦º", "ä»£è©", "å¤–åœ¨æ´»å‹•èˆ‡å‹•ä½œ", "ç”Ÿç‰©",
            "è‡ªç„¶èˆ‡æ™¯è§€", "äº‹ç‰©ç‹€æ…‹èˆ‡è®ŠåŒ–", "å±…å®¶ç”Ÿæ´»", "æŠ½è±¡æ¦‚å¿µèˆ‡å½¢å®¹",
            "æ³•å¾‹ã€æ”¿æ²»èˆ‡è»äº‹", "ç¤¾æœƒé—œä¿‚èˆ‡è¡Œç‚º", "æ™‚ç©ºèˆ‡æƒ…ç‹€å‰¯è©", "ç‰¹æ®Šè©é¡",
            "é€šè¨Šã€å»ºè¨­èˆ‡äº¤é€š", "æ­²æ™‚ç¥­å„€ã€ç¿’ä¿—èˆ‡å®—æ•™", "æ•¸è©é‡è©", "è·æ¥­èˆ‡ç¶“æ¿Ÿ", "è—æ–‡èˆ‡æ•™è‚²"
        ];

        function csvToArray(str, delimiter = ',') {
            const rows = str.trim().split('\n');
            if (rows.length < 1) return [];
            
            // è™•ç† CSV æª”é ­å¯èƒ½å­˜åœ¨çš„ UTF-8 BOM å­—å…ƒ
            const firstRow = rows[0].charCodeAt(0) === 0xFEFF ? rows[0].substring(1) : rows[0];
            const headers = firstRow.split(delimiter).map(h => h.trim());
            
            const data = [];
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].trim() === '') continue;
                const values = rows[i].split(delimiter);
                const obj = {};
                let hasValue = false;
                for (let j = 0; j < headers.length; j++) {
                    const value = values[j] ? values[j].trim() : '';
                    obj[headers[j]] = value;
                    if (value) hasValue = true;
                }
                // ç¢ºä¿è©²è¡Œè‡³å°‘æœ‰ä¸€å€‹ header æœ‰å€¼ï¼Œä¸”ç¬¬ä¸€å€‹ header (é€šå¸¸æ˜¯ç·¨è™Ÿ) å­˜åœ¨
                if (hasValue && obj[headers[0]]) {
                     data.push(obj);
                }
            }
            return data;
        }

        function constructDialectInfo(fullLvlName, varNameShort) {
            let è…” = varNameShort.substring(0, 1);
            let ç´š = varNameShort.substring(1);

            let selectedä¾‹å¤–éŸ³æª”;
            switch (ç´š) {
                case 'åŸº': selectedä¾‹å¤–éŸ³æª” = typeof åŸºä¾‹å¤–éŸ³æª” !== 'undefined' ? åŸºä¾‹å¤–éŸ³æª” : []; break;
                case 'åˆ': selectedä¾‹å¤–éŸ³æª” = typeof åˆä¾‹å¤–éŸ³æª” !== 'undefined' ? åˆä¾‹å¤–éŸ³æª” : []; break;
                case 'ä¸­': selectedä¾‹å¤–éŸ³æª” = typeof ä¸­ä¾‹å¤–éŸ³æª” !== 'undefined' ? ä¸­ä¾‹å¤–éŸ³æª” : []; break;
                case 'ä¸­é«˜': selectedä¾‹å¤–éŸ³æª” = typeof ä¸­é«˜ä¾‹å¤–éŸ³æª” !== 'undefined' ? ä¸­é«˜ä¾‹å¤–éŸ³æª” : []; break;
                case 'é«˜': selectedä¾‹å¤–éŸ³æª” = typeof é«˜ä¾‹å¤–éŸ³æª” !== 'undefined' ? é«˜ä¾‹å¤–éŸ³æª” : []; break;
                default:
                    logMessage(`å»ºæ§‹ dialectInfo å¤±æ•—ï¼šæœªçŸ¥çš„ç´šåˆ¥ç°¡ç¨± "${ç´š}" ä¾†è‡ª ${varNameShort}`, 'error');
                    selectedä¾‹å¤–éŸ³æª” = [];
            }

            const info = {
                è…”: è…”,
                ç´š: ç´š,
                ä¾‹å¤–éŸ³æª”: selectedä¾‹å¤–éŸ³æª”,
                fullLvlName: fullLvlName,
                generalMediaYr: '112',
                è…”å: '', ç´šå: '', æª”è…”: '', æª”ç´š: '', ç›®éŒ„ç´š: '', ç›®éŒ„å¦ç´š: undefined
            };

            switch (è…”) {
                case 'å››': info.æª”è…” = 'si'; info.è…”å = 'å››ç¸£'; break;
                case 'æµ·': info.æª”è…” = 'ha'; info.è…”å = 'æµ·é™¸'; break;
                case 'å¤§': info.æª”è…” = 'da'; info.è…”å = 'å¤§åŸ”'; break;
                case 'å¹³': info.æª”è…” = 'rh'; info.è…”å = 'é¥’å¹³'; break;
                case 'å®‰': info.æª”è…” = 'zh'; info.è…”å = 'è©”å®‰'; break;
                default:
                    logMessage(`å»ºæ§‹ dialectInfo å¤±æ•—ï¼šæœªçŸ¥çš„è…”èª¿ç°¡ç¨± "${è…”}" ä¾†è‡ª ${varNameShort}`, 'error');
                    return null;
            }

            switch (ç´š) {
                case 'åŸº': info.ç›®éŒ„ç´š = '5'; info.ç›®éŒ„å¦ç´š = '1'; info.ç´šå = 'åŸºç¤ç´š'; info.æª”ç´š = ''; break;
                case 'åˆ': info.ç›®éŒ„ç´š = '1'; info.ç´šå = 'åˆç´š'; info.æª”ç´š = ''; break;
                case 'ä¸­': info.ç›®éŒ„ç´š = '2'; info.æª”ç´š = '1'; info.ç´šå = 'ä¸­ç´š'; break;
                case 'ä¸­é«˜': info.ç›®éŒ„ç´š = '3'; info.æª”ç´š = '2'; info.ç´šå = 'ä¸­é«˜ç´š'; break;
                case 'é«˜': info.ç›®éŒ„ç´š = '4'; info.æª”ç´š = '3'; info.ç´šå = 'é«˜ç´š'; break;
                default:
                    logMessage(`å»ºæ§‹ dialectInfo å¤±æ•—ï¼šæœªçŸ¥çš„ç´šåˆ¥ç°¡ç¨± "${ç´š}" ä¾†è‡ª ${varNameShort} (ç¬¬äºŒæ¬¡æª¢æŸ¥)`, 'error');
                    return null;
            }
            return info;
        }

        function getAudioFilePaths(line, dialectInfo) {
            let mediaYr = dialectInfo.generalMediaYr;
            let pre112Insertionè© = '';
            let pre112Insertionå¥ = '';
            let è©ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„ç´š;
            let å¥ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„ç´š;
            let mediaNo = '';

            if (!line.ç·¨è™Ÿ) {
                // logMessage(`é …ç›®ç¼ºå°‘ã€Œç·¨è™Ÿã€æ¬„ä½: ${JSON.stringify(line)}`, 'error');
                return { wordAudioUrl: null, sentenceAudioUrl: null };
            }

            var no = line.ç·¨è™Ÿ.split('-');
            if (no.length < 2) {
                 // logMessage(`é …ç›®ã€Œç·¨è™Ÿã€æ ¼å¼éŒ¯èª¤ (${line.ç·¨è™Ÿ}): ${JSON.stringify(line)}`, 'error');
                 return { wordAudioUrl: null, sentenceAudioUrl: null };
            }

            if (parseInt(no[0], 10) <= 9) no[0] = '0' + parseInt(no[0], 10);
            if (dialectInfo.ç´š === 'åˆ' && parseInt(no[0], 10) <= 99) { // åˆç´šçš„ no[0] å¯èƒ½åˆ°å…©ä½æ•¸
                 if (parseInt(no[0], 10) <=9) no[0] = '0' + no[0]; // ç¢ºä¿å…©ä½æ•¸
                 else no[0] = String(parseInt(no[0],10)); // å·²ç¶“å…©ä½æ•¸
            } else if (dialectInfo.ç´š === 'åˆ') { // åˆç´šç‰¹æ®Šè™•ç†ï¼Œè‹¥å¤§æ–¼99å‰‡ä¸è£œ0
                 no[0] = String(parseInt(no[0],10));
            }


            let no1_num = parseInt(no[1], 10);
            if (no1_num <= 9) mediaNo = '00' + no1_num;
            else if (no1_num <= 99) mediaNo = '0' + no1_num;
            else mediaNo = String(no1_num);


            const index = dialectInfo.ä¾‹å¤–éŸ³æª”.findIndex(([ç·¨è™Ÿ]) => ç·¨è™Ÿ === line.ç·¨è™Ÿ);
            if (index !== -1) {
                const matchedElement = dialectInfo.ä¾‹å¤–éŸ³æª”[index];
                mediaYr = matchedElement[1];
                mediaNo = matchedElement[2]; // ä¾‹å¤– mediaNo æ ¼å¼å·²æ­£ç¢º
                pre112Insertionè© = 'w/';
                pre112Insertionå¥ = 's/';
                if (dialectInfo.ç›®éŒ„å¦ç´š !== undefined) {
                    è©ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„å¦ç´š;
                    å¥ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„å¦ç´š;
                }
            }

            const è©ç›®éŒ„ = è©ç›®éŒ„ç´š + '/' + dialectInfo.æª”è…” + '/' + pre112Insertionè© + dialectInfo.æª”ç´š + dialectInfo.æª”è…”;
            const å¥ç›®éŒ„ = å¥ç›®éŒ„ç´š + '/' + dialectInfo.æª”è…” + '/' + pre112Insertionå¥ + dialectInfo.æª”ç´š + dialectInfo.æª”è…”;

            const wordAudioUrl = `https://elearning.hakka.gov.tw/hakka/files/cert/vocabulary/${mediaYr}/${è©ç›®éŒ„}-${no[0]}-${mediaNo}.mp3`;
            let sentenceAudioUrl = null;

            const hasExampleSentenceText = line.ä¾‹å¥ && line.ä¾‹å¥.trim() !== '';
            if (hasExampleSentenceText && dialectInfo.ç´šå !== 'é«˜ç´š') {
                sentenceAudioUrl = `https://elearning.hakka.gov.tw/hakka/files/cert/vocabulary/${mediaYr}/${å¥ç›®éŒ„}-${no[0]}-${mediaNo}s.mp3`;
            }

            return { wordAudioUrl, sentenceAudioUrl };
        }

        function checkAudioUrlExists(url) {
            return new Promise((resolve) => {
                const audio = new Audio();
                let timeoutId;

                const onError = () => {
                    cleanup();
                    resolve(true); // éŒ¯èª¤ (404, CORS, etc.)
                };
                const onCanPlay = () => {
                    cleanup();
                    resolve(false); // éŸ³æª”å¯æ’­æ”¾ (æˆ–è‡³å°‘ä¸­ä»‹è³‡æ–™å·²è¼‰å…¥)
                };
                const onTimeout = () => {
                    cleanup();
                    logMessage(`  æª¢æŸ¥è¶…æ™‚: ${url}`, 'error');
                    resolve(true); // è¶…æ™‚ç•¶ä½œéŒ¯èª¤
                };

                function cleanup() {
                    clearTimeout(timeoutId);
                    audio.removeEventListener('error', onError);
                    audio.removeEventListener('canplaythrough', onCanPlay);
                    audio.removeEventListener('loadeddata', onCanPlay);
                    audio.src = ''; // é‡‹æ”¾è³‡æº
                }

                timeoutId = setTimeout(onTimeout, 7000); // 7 ç§’è¶…æ™‚

                audio.addEventListener('error', onError, { once: true });
                audio.addEventListener('loadeddata', onCanPlay, { once: true });
                
                audio.src = url;
            });
        }

        async function checkAndLogAudio(url, dialectFull, category, itemId, itemHakka, urlType) {
            const isError = await checkAudioUrlExists(url);
            if (isError) {
                logMessage(`âŒ å•é¡Œ (${urlType}): ${dialectFull} > ${category} > ç·¨è™Ÿ ${itemId} (${itemHakka.substring(0,10)}...) \n   URL: ${url}`, 'error');
                return true;
            } else {
                // logMessage(`âœ”ï¸ æ­£å¸¸ (${urlType}): ${dialectFull} > ${category} > ç·¨è™Ÿ ${itemId}`, 'success'); // å¯é¸ï¼šé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                return false;
            }
        }

        function logMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            if (type === 'error') p.classList.add('error');
            else if (type === 'success') p.classList.add('success');
            else p.classList.add('info'); // Default to info if not error/success
            
            resultsDiv.appendChild(p);
            resultsDiv.scrollTop = resultsDiv.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        }

        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            resultsDiv.innerHTML = '';
            statusDiv.textContent = 'ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­ï¼Œè«‹ç¨å€™...';
            let totalErrors = 0;
            let totalChecked = 0;

            for (const dl of DIALECT_LEVELS) {
                if (!dl.data || !dl.data.content) {
                    logMessage(`è³‡æ–™æœªå®šç¾©æˆ–ç„¡å…§å®¹: ${dl.name} (è®Šæ•¸å: ${dl.varName})`, 'error');
                    continue;
                }
                logMessage(`\n--- é–‹å§‹æª¢æŸ¥: ${dl.name} ---`, 'info');

                const dialectInfo = constructDialectInfo(dl.name, dl.varName);
                if (!dialectInfo) {
                    logMessage(`ç„¡æ³•ç‚º ${dl.name} å»ºæ§‹ dialectInfoï¼Œè·³éæ­¤é …ã€‚`, 'error');
                    continue;
                }

                let vocabularyArray;
                try {
                    vocabularyArray = csvToArray(dl.data.content);
                } catch (e) {
                    logMessage(`è§£æ ${dl.name} çš„ CSV è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${e.message}`, 'error');
                    continue;
                }


                for (const category of CATEGORIES) {
                    // logMessage(`  æª¢æŸ¥é¡åˆ¥: ${category}`, 'info');
                    const filteredItems = vocabularyArray.filter(
                        (line) => line.åˆ†é¡ && line.åˆ†é¡.includes(category)
                    );

                    if (filteredItems.length === 0) {
                        continue;
                    }

                    for (const item of filteredItems) {
                        if (!item.ç·¨è™Ÿ || !item.å®¢å®¶èª) {
                            // logMessage(`    é …ç›®è³‡æ–™ä¸å®Œæ•´ (ç¼ºå°‘ç·¨è™Ÿæˆ–å®¢å®¶èª)ï¼Œè·³é: ${JSON.stringify(item).substring(0,100)}...`, 'info');
                            continue;
                        }

                        const audioUrls = getAudioFilePaths(item, dialectInfo);

                        if (audioUrls.wordAudioUrl) {
                            totalChecked++;
                            statusDiv.textContent = `ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­ (${totalChecked} å€‹éŸ³æª”)... ${dl.name} > ${category.substring(0,3)}... > ${item.ç·¨è™Ÿ}`;
                            const isWordError = await checkAndLogAudio(audioUrls.wordAudioUrl, dl.name, category, item.ç·¨è™Ÿ, item.å®¢å®¶èª, 'è©å½™');
                            if (isWordError) totalErrors++;
                        }
                        if (audioUrls.sentenceAudioUrl) {
                            totalChecked++;
                            statusDiv.textContent = `ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­ (${totalChecked} å€‹éŸ³æª”)... ${dl.name} > ${category.substring(0,3)}... > ${item.ç·¨è™Ÿ}`;
                            const isSentenceError = await checkAndLogAudio(audioUrls.sentenceAudioUrl, dl.name, category, item.ç·¨è™Ÿ, item.å®¢å®¶èª, 'ä¾‹å¥');
                            if (isSentenceError) totalErrors++;
                        }
                         // çŸ­æš«å»¶é²ï¼Œé¿å…åŒæ™‚ç™¼é€éå¤šè«‹æ±‚ï¼Œæ¸›è¼•ç€è¦½å™¨è² æ“”
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
                logMessage(`--- ${dl.name} æª¢æŸ¥å®Œç•¢ ---`, 'info');
            }
            statusDiv.textContent = `ç‹€æ…‹ï¼šå…¨éƒ¨æª¢æŸ¥å®Œæˆï¼å…±æª¢æŸ¥ ${totalChecked} å€‹éŸ³æª”ï¼Œç™¼ç¾ ${totalErrors} å€‹å•é¡ŒéŸ³æª”ã€‚`;
            startButton.disabled = false;
            logMessage(`\nğŸ‰ å…¨éƒ¨æª¢æŸ¥å®Œæˆï¼å…±æª¢æŸ¥ ${totalChecked} å€‹éŸ³æª”ï¼Œç™¼ç¾ ${totalErrors} å€‹å•é¡ŒéŸ³æª”ã€‚`, 'info');
        });

    </script>
</body>
</html>
