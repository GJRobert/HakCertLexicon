<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å®¢èªèªè­‰è©å½™ç„¡æ•ˆéŸ³æª”æª¢æŸ¥å™¨</title>
    <!-- è¼‰å…¥æ‰€æœ‰è©å½™è³‡æ–™ JS æª”æ¡ˆ -->
    <script src="113å››åŸº.js"></script>
    <script src="113å››åˆ.js"></script>
    <script src="113å››ä¸­.js"></script>
    <script src="113å››ä¸­é«˜.js"></script>
    <script src="113å››é«˜.js"></script>
    <script src="113æµ·åŸº.js"></script>
    <script src="113æµ·åˆ.js"></script>
    <script src="113æµ·ä¸­.js"></script>
    <script src="113æµ·ä¸­é«˜.js"></script>
    <script src="113å¤§åŸº.js"></script>
    <script src="113å¤§åˆ.js"></script>
    <script src="113å¤§ä¸­.js"></script>
    <script src="113å¹³åŸº.js"></script>
    <script src="113å®‰åŸº.js"></script>
    <!-- è¼‰å…¥ä¾‹å¤–éŸ³æª”è¨­å®š -->
    <script src="exclusions.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; margin: 20px; line-height: 1.6; }
        h1 { color: #333; }
        p { color: #555; }
        button {
            background-color: #007bff; color: white; border: none;
            padding: 10px 15px; font-size: 16px; border-radius: 5px;
            cursor: pointer; transition: background-color 0.3s ease;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 15px; font-weight: bold; }
        #results {
            margin-top: 15px; border: 1px solid #ddd; padding: 15px;
            height: 500px; overflow-y: scroll; white-space: pre-wrap; /* æ”¹ç‚º pre-wrap ä¿ç•™æ›è¡Œ */
            font-family: "Courier New", Courier, monospace; font-size: 14px;
            background-color: #f9f9f9; border-radius: 5px;
        }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
        .success { color: #28a745; }
        .item-info { margin-bottom: 5px; }
        .debug { color: #6c757d; font-style: italic; font-size: 0.9em; } /* é™¤éŒ¯è¨Šæ¯æ¨£å¼ */
    </style>
</head>
<body>
    <h1>å®¢èªèªè­‰è©å½™ç„¡æ•ˆéŸ³æª”æª¢æŸ¥å™¨</h1>
    <p>é€™æ”¯å·¥å…·æœƒæª¢æŸ¥æ‰€æœ‰è…”èª¿ã€ç´šåˆ¥ã€é¡åˆ¥è©å½™çš„éŸ³æª”ï¼Œçœ‹æ•¢æœ‰å¤±æ•ˆ (ä¾‹å¦‚ 404 éŒ¯èª¤) æˆ–å›  CORS è¨­å®šè€Œç„¡æ³•å­˜å–çš„é€£çµã€‚</p>
    <p><strong>æ³¨æ„ï¼š</strong>æª¢æŸ¥éç¨‹å¯èƒ½æœƒèŠ±å…œæ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…ã€‚çµæœæœƒé¡¯ç¤ºåœ¨ä¸‹æ–¹ã€‚</p>
    <button id="startButton">é–‹å§‹æª¢æŸ¥</button>
    <div id="status">ç‹€æ…‹ï¼šé‚„æœªé–‹å§‹</div>
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        const statusDiv = document.getElementById('status');
        const startButton = document.getElementById('startButton');

        // å¾ index.html æ•´ç†å‡ºä¾†çš„è…”èª¿ç´šåˆ¥è³‡æ–™
        const DIALECT_LEVELS = [
            { name: "å››ç¸£åŸºç¤ç´š", varName: "å››åŸº", data: typeof å››åŸº !== 'undefined' ? å››åŸº : null },
            { name: "å››ç¸£åˆç´š",   varName: "å››åˆ", data: typeof å››åˆ !== 'undefined' ? å››åˆ : null },
            { name: "å››ç¸£ä¸­ç´š",   varName: "å››ä¸­", data: typeof å››ä¸­ !== 'undefined' ? å››ä¸­ : null },
            { name: "å››ç¸£ä¸­é«˜ç´š", varName: "å››ä¸­é«˜", data: typeof å››ä¸­é«˜ !== 'undefined' ? å››ä¸­é«˜ : null },
            { name: "å››ç¸£é«˜ç´š",   varName: "å››é«˜", data: typeof å››é«˜ !== 'undefined' ? å››é«˜ : null },
            { name: "æµ·é™¸åŸºç¤ç´š", varName: "æµ·åŸº", data: typeof æµ·åŸº !== 'undefined' ? æµ·åŸº : null },
            { name: "æµ·é™¸åˆç´š",   varName: "æµ·åˆ", data: typeof æµ·åˆ !== 'undefined' ? æµ·åˆ : null },
            { name: "æµ·é™¸ä¸­ç´š",   varName: "æµ·ä¸­", data: typeof æµ·ä¸­ !== 'undefined' ? æµ·ä¸­ : null },
            { name: "æµ·é™¸ä¸­é«˜ç´š", varName: "æµ·ä¸­é«˜", data: typeof æµ·ä¸­é«˜ !== 'undefined' ? æµ·ä¸­é«˜ : null },
            { name: "å¤§åŸ”åŸºç¤ç´š", varName: "å¤§åŸº", data: typeof å¤§åŸº !== 'undefined' ? å¤§åŸº : null },
            { name: "å¤§åŸ”åˆç´š",   varName: "å¤§åˆ", data: typeof å¤§åˆ !== 'undefined' ? å¤§åˆ : null },
            { name: "å¤§åŸ”ä¸­ç´š",   varName: "å¤§ä¸­", data: typeof å¤§ä¸­ !== 'undefined' ? å¤§ä¸­ : null },
            { name: "é¥’å¹³åŸºç¤ç´š", varName: "å¹³åŸº", data: typeof å¹³åŸº !== 'undefined' ? å¹³åŸº : null },
            { name: "è©”å®‰åŸºç¤ç´š", varName: "å®‰åŸº", data: typeof å®‰åŸº !== 'undefined' ? å®‰åŸº : null }
        ];

        // å¾ index.html æ•´ç†å‡ºä¾†çš„åˆ†é¡
        const CATEGORIES = [
            "äººé«”èˆ‡é†«ç™‚", "å¿ƒç†æ´»å‹•èˆ‡æ„Ÿè¦º", "ä»£è©", "å¤–åœ¨æ´»å‹•èˆ‡å‹•ä½œ", "ç”Ÿç‰©",
            "è‡ªç„¶èˆ‡æ™¯è§€", "äº‹ç‰©ç‹€æ…‹èˆ‡è®ŠåŒ–", "å±…å®¶ç”Ÿæ´»", "æŠ½è±¡æ¦‚å¿µèˆ‡å½¢å®¹",
            "æ³•å¾‹ã€æ”¿æ²»èˆ‡è»äº‹", "ç¤¾æœƒé—œä¿‚èˆ‡è¡Œç‚º", "æ™‚ç©ºèˆ‡æƒ…ç‹€å‰¯è©", "ç‰¹æ®Šè©é¡",
            "é€šè¨Šã€å»ºè¨­èˆ‡äº¤é€š", "æ­²æ™‚ç¥­å„€ã€ç¿’ä¿—èˆ‡å®—æ•™", "æ•¸è©é‡è©", "è·æ¥­èˆ‡ç¶“æ¿Ÿ", "è—æ–‡èˆ‡æ•™è‚²"
        ];

        // æ–°å¢ï¼šçµ±ä¸€è¨˜éŒ„åˆ°é é¢å’Œæ§åˆ¶å°çš„å‡½å¼
        function logToPageAndConsole(message, type = 'debug') {
            console.log(message); // å›ºå®šå°åˆ° console

            const p = document.createElement('p');
            // å°‡è¨Šæ¯ä¸­çš„æ›è¡Œç¬¦ \n è½‰æ›ç‚º <br> ä»¥ä¾¿åœ¨ HTML ä¸­æ­£ç¢ºé¡¯ç¤º
            p.innerHTML = message.replace(/\n/g, '<br>');
            
            if (type === 'error') p.classList.add('error');
            else if (type === 'success') p.classList.add('success');
            else if (type === 'info') p.classList.add('info');
            else p.classList.add('debug');
            
            resultsDiv.appendChild(p);
            // è‡ªå‹•æ²å‹•ï¼Œä½†é™åˆ¶ debug è¨Šæ¯çš„æ²å‹•ï¼Œé¿å…é é¢è·³å‹•å¤ªé »ç¹
            if (type !== 'debug' || resultsDiv.childElementCount < 50) { 
                 resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }
        }


        function csvToArray(str, delimiter = ',') {
            if (!str || typeof str !== 'string') {
                logToPageAndConsole('csvToArray: è¼¸å…¥çš„å­—ä¸²ç„¡æ•ˆæˆ–æœªå®šç¾©ã€‚', 'error');
                return [];
            }
            const rows = str.trim().split('\n');
            if (rows.length < 1) {
                logToPageAndConsole('csvToArray: å­—ä¸² trim å¾Œç‚ºç©ºæˆ– split å¾Œç„¡ä»»ä½•åˆ—ã€‚', 'debug');
                return [];
            }
            
            const firstRow = rows[0].charCodeAt(0) === 0xFEFF ? rows[0].substring(1) : rows[0];
            const headers = firstRow.split(delimiter).map(h => h.trim());
            
            if (headers.length === 0 || (headers.length === 1 && headers[0] === '')) {
                logToPageAndConsole('csvToArray: ç„¡æ³•è§£ææª”é ­ï¼Œæˆ–æª”é ­ç‚ºç©ºã€‚', 'error');
                return [];
            }
            // logToPageAndConsole(`csvToArray: è§£æåˆ°çš„æª”é ­: ${headers.join(', ')}`, 'debug'); // é€™è¡Œè¨Šæ¯å¯èƒ½å¤ªé•·

            const data = [];
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].trim() === '') continue;
                const values = rows[i].split(delimiter);
                const obj = {};
                let hasValue = false;
                for (let j = 0; j < headers.length; j++) {
                    const value = values[j] ? values[j].trim() : '';
                    obj[headers[j]] = value;
                    if (value) hasValue = true;
                }
                if (hasValue && obj[headers[0]] && obj[headers[0]].trim() !== '') { // ç¢ºä¿ç·¨è™Ÿå­˜åœ¨ä¸”ä¸ç‚ºç©º
                     data.push(obj);
                }
            }
            // logToPageAndConsole(`csvToArray: å…±è§£æåˆ° ${data.length} ç­†è³‡æ–™ã€‚`, 'debug'); // ç§»åˆ°ä¸»è¿´åœˆå…§é¡¯ç¤º
            return data;
        }

        function constructDialectInfo(fullLvlName, varNameShort) {
            let è…” = varNameShort.substring(0, 1);
            let ç´š = varNameShort.substring(1);

            let selectedä¾‹å¤–éŸ³æª”;
            switch (ç´š) {
                case 'åŸº': selectedä¾‹å¤–éŸ³æª” = typeof åŸºä¾‹å¤–éŸ³æª” !== 'undefined' ? åŸºä¾‹å¤–éŸ³æª” : []; break;
                case 'åˆ': selectedä¾‹å¤–éŸ³æª” = typeof åˆä¾‹å¤–éŸ³æª” !== 'undefined' ? åˆä¾‹å¤–éŸ³æª” : []; break;
                case 'ä¸­': selectedä¾‹å¤–éŸ³æª” = typeof ä¸­ä¾‹å¤–éŸ³æª” !== 'undefined' ? ä¸­ä¾‹å¤–éŸ³æª” : []; break;
                case 'ä¸­é«˜': selectedä¾‹å¤–éŸ³æª” = typeof ä¸­é«˜ä¾‹å¤–éŸ³æª” !== 'undefined' ? ä¸­é«˜ä¾‹å¤–éŸ³æª” : []; break;
                case 'é«˜': selectedä¾‹å¤–éŸ³æª” = typeof é«˜ä¾‹å¤–éŸ³æª” !== 'undefined' ? é«˜ä¾‹å¤–éŸ³æª” : []; break;
                default:
                    logToPageAndConsole(`å»ºæ§‹ dialectInfo å¤±æ•—ï¼šæœªçŸ¥çš„ç´šåˆ¥ç°¡ç¨± "${ç´š}" ä¾†è‡ª ${varNameShort}`, 'error');
                    selectedä¾‹å¤–éŸ³æª” = [];
            }

            const info = {
                è…”: è…”,
                ç´š: ç´š,
                ä¾‹å¤–éŸ³æª”: selectedä¾‹å¤–éŸ³æª”,
                fullLvlName: fullLvlName,
                generalMediaYr: '112',
                è…”å: '', ç´šå: '', æª”è…”: '', æª”ç´š: '', ç›®éŒ„ç´š: '', ç›®éŒ„å¦ç´š: undefined
            };

            switch (è…”) {
                case 'å››': info.æª”è…” = 'si'; info.è…”å = 'å››ç¸£'; break;
                case 'æµ·': info.æª”è…” = 'ha'; info.è…”å = 'æµ·é™¸'; break;
                case 'å¤§': info.æª”è…” = 'da'; info.è…”å = 'å¤§åŸ”'; break;
                case 'å¹³': info.æª”è…” = 'rh'; info.è…”å = 'é¥’å¹³'; break;
                case 'å®‰': info.æª”è…” = 'zh'; info.è…”å = 'è©”å®‰'; break;
                default:
                    logToPageAndConsole(`å»ºæ§‹ dialectInfo å¤±æ•—ï¼šæœªçŸ¥çš„è…”èª¿ç°¡ç¨± "${è…”}" ä¾†è‡ª ${varNameShort}`, 'error');
                    return null;
            }

            switch (ç´š) {
                case 'åŸº': info.ç›®éŒ„ç´š = '5'; info.ç›®éŒ„å¦ç´š = '1'; info.ç´šå = 'åŸºç¤ç´š'; info.æª”ç´š = ''; break;
                case 'åˆ': info.ç›®éŒ„ç´š = '1'; info.ç´šå = 'åˆç´š'; info.æª”ç´š = ''; break;
                case 'ä¸­': info.ç›®éŒ„ç´š = '2'; info.æª”ç´š = '1'; info.ç´šå = 'ä¸­ç´š'; break;
                case 'ä¸­é«˜': info.ç›®éŒ„ç´š = '3'; info.æª”ç´š = '2'; info.ç´šå = 'ä¸­é«˜ç´š'; break;
                case 'é«˜': info.ç›®éŒ„ç´š = '4'; info.æª”ç´š = '3'; info.ç´šå = 'é«˜ç´š'; break;
                default:
                    logToPageAndConsole(`å»ºæ§‹ dialectInfo å¤±æ•—ï¼šæœªçŸ¥çš„ç´šåˆ¥ç°¡ç¨± "${ç´š}" ä¾†è‡ª ${varNameShort} (ç¬¬äºŒæ¬¡æª¢æŸ¥)`, 'error');
                    return null;
            }
            return info;
        }

        function getAudioFilePaths(line, dialectInfo) {
            let mediaYr = dialectInfo.generalMediaYr;
            let pre112Insertionè© = '';
            let pre112Insertionå¥ = '';
            let è©ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„ç´š;
            let å¥ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„ç´š;
            let mediaNo = '';

            const hakkaTermKey = dialectInfo.è…”å + 'å®¢å®¶èª'; // å‹•æ…‹ç”¢ç”Ÿå®¢å®¶èªæ¬„ä½å
            const exampleSentenceKey = dialectInfo.è…”å + 'ä¾‹å¥'; // å‹•æ…‹ç”¢ç”Ÿä¾‹å¥æ¬„ä½å

            if (!line.ç·¨è™Ÿ || !line[hakkaTermKey]) { // æª¢æŸ¥å‹•æ…‹ä¸ªå®¢å®¶èªæ¬„ä½
                return { wordAudioUrl: null, sentenceAudioUrl: null };
            }
            var no = line.ç·¨è™Ÿ.split('-');
            if (no.length < 2) { //ç·¨è™Ÿæœ¬èº«æ ¼å¼éŒ¯èª¤
                 return { wordAudioUrl: null, sentenceAudioUrl: null };
            }

            // æ­£ç¢ºæ¨¡æ“¬ main.js å…§åº• `if (no[0] <= 9)` (å­—ä¸²å°æ•¸å­—) ä¸ªæ¯”è¼ƒé‚è¼¯
            // JavaScript æœƒå˜—è©¦å°‡ no[0] (å­—ä¸²) è½‰ç‚ºæ•¸å­—å¾Œå†åŒ 9 (æ•¸å­—) æ¯”è¼ƒ
            let no_0_as_number = parseInt(no[0], 10);
            if (!isNaN(no_0_as_number) && no_0_as_number <= 9) {
                // åªæœ‰åœ¨ no[0] ç¢ºå¯¦ä¿‚æ•¸å­—ä¸”ç´°æ–¼ç­‰æ–¼ 9 æ™‚ï¼Œæ­£æœƒåŠ  '0'
                no[0] = '0' + no[0];
            }

            // è‹¥ä¿‚åˆç´šï¼Œå†åŠ ä¸€å€‹ '0'
            if (dialectInfo.ç´š === 'åˆ') {
                no[0] = '0' + no[0];
            }

            let no1_val = parseInt(no[1], 10);
            if (isNaN(no1_val)) { 
                logToPageAndConsole(`getAudioFilePaths: ç·¨è™Ÿ ${line.ç·¨è™Ÿ} çš„ç¬¬äºŒéƒ¨åˆ† (${no[1]}) ç„¡æ³•è½‰æ›ç‚ºæ•¸å­—ã€‚`, 'error');
                return { wordAudioUrl: null, sentenceAudioUrl: null };
            }

            if (no1_val <= 9) mediaNo = '00' + no1_val;
            else if (no1_val <= 99) mediaNo = '0' + no1_val;
            else mediaNo = String(no1_val);
            
            const index = dialectInfo.ä¾‹å¤–éŸ³æª”.findIndex(([ç·¨è™Ÿ]) => ç·¨è™Ÿ === line.ç·¨è™Ÿ);
            if (index !== -1) {
                const matchedElement = dialectInfo.ä¾‹å¤–éŸ³æª”[index];
                mediaYr = matchedElement[1];
                mediaNo = matchedElement[2]; 
                pre112Insertionè© = 'w/';
                pre112Insertionå¥ = 's/';
                if (dialectInfo.ç›®éŒ„å¦ç´š !== undefined) {
                    è©ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„å¦ç´š;
                    å¥ç›®éŒ„ç´š = dialectInfo.ç›®éŒ„å¦ç´š;
                }
            }

            const è©ç›®éŒ„ = è©ç›®éŒ„ç´š + '/' + dialectInfo.æª”è…” + '/' + pre112Insertionè© + dialectInfo.æª”ç´š + dialectInfo.æª”è…”;
            const å¥ç›®éŒ„ = å¥ç›®éŒ„ç´š + '/' + dialectInfo.æª”è…” + '/' + pre112Insertionå¥ + dialectInfo.æª”ç´š + dialectInfo.æª”è…”;

            const wordAudioUrl = `https://elearning.hakka.gov.tw/hakka/files/cert/vocabulary/${mediaYr}/${è©ç›®éŒ„}-${no[0]}-${mediaNo}.mp3`;
            let sentenceAudioUrl = null;

            const exampleSentenceText = line[exampleSentenceKey]; // ç”¨å‹•æ…‹æ¬„ä½åè®€å–ä¾‹å¥
            if (exampleSentenceText && exampleSentenceText.trim() !== '' && dialectInfo.ç´šå !== 'é«˜ç´š') {
                sentenceAudioUrl = `https://elearning.hakka.gov.tw/hakka/files/cert/vocabulary/${mediaYr}/${å¥ç›®éŒ„}-${no[0]}-${mediaNo}s.mp3`;
            }

            return { wordAudioUrl, sentenceAudioUrl };
        }

        function checkAudioUrlExists(url) {
            return new Promise((resolve) => {
                const audio = new Audio();
                let timeoutId;

                const onError = () => {
                    cleanup();
                    resolve(true); 
                };
                const onCanPlay = () => { // 'loadeddata' or 'canplaythrough'
                    cleanup();
                    resolve(false); 
                };
                const onTimeout = () => {
                    cleanup();
                    logToPageAndConsole(`  æª¢æŸ¥è¶…æ™‚ (7ç§’): ${url}`, 'error');
                    resolve(true); 
                };

                function cleanup() {
                    clearTimeout(timeoutId);
                    audio.removeEventListener('error', onError);
                    audio.removeEventListener('canplaythrough', onCanPlay); // Check both
                    audio.removeEventListener('loadeddata', onCanPlay);     // Check both
                    audio.src = ''; // Release resources
                    // audio = null; // Optional: help GC
                }

                timeoutId = setTimeout(onTimeout, 7000); 

                audio.addEventListener('error', onError, { once: true });
                // Listen to 'loadeddata' as it fires earlier than 'canplaythrough'
                // and is sufficient to know the metadata (and thus existence) is loaded.
                audio.addEventListener('loadeddata', onCanPlay, { once: true }); 
                
                audio.src = url;
                audio.load(); // Explicitly call load
            });
        }

        async function checkAndLogAudio(url, dialectFull, category, itemId, itemHakka, urlType) {
            const isError = await checkAudioUrlExists(url);
            if (isError) {
                // ç¢ºèª itemHakka æ˜¯å¦æœ‰å€¼ï¼Œè‹¥ç„¡å‰‡æä¾›é è¨­æ–‡å­—
                const hakkaDisplay = itemHakka ? itemHakka.substring(0,10) + '...' : '(å®¢å®¶èªè©å½™è®€å–å¤±æ•—)';
                logToPageAndConsole(`âŒ å•é¡Œ (${urlType}): ${dialectFull} > ${category} > ç·¨è™Ÿ ${itemId} (${hakkaDisplay}) \n   URL: ${url}`, 'error');
                return true;
            } else {
                // logToPageAndConsole(`âœ”ï¸ æ­£å¸¸ (${urlType}): ${dialectFull} > ${category} > ç·¨è™Ÿ ${itemId}`, 'success'); // å¯é¸ï¼šé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                return false;
            }
        }
        
        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            resultsDiv.innerHTML = ''; 
            logToPageAndConsole("æª¢æŸ¥é–‹å§‹...", "info");
            statusDiv.textContent = 'ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­ï¼Œè«‹ç¨å€™...';
            let totalErrors = 0;
            let totalChecked = 0;
            let itemsProcessed = 0; // è¨˜éŒ„å¯¦éš›è™•ç†çš„è©å½™é …ç›®æ•¸é‡

            // æª¢æŸ¥ DIALECT_LEVELS æ˜¯å¦æ­£ç¢ºè¼‰å…¥è³‡æ–™
            logToPageAndConsole(`DIALECT_LEVELS å…§å®¹æ¦‚è¦: ${JSON.stringify(DIALECT_LEVELS.map(d => ({name: d.name, varName: d.varName, hasData: !!d.data, hasContent: !!(d.data && d.data.content) })))}`, 'debug');

            for (const dl of DIALECT_LEVELS) {
                logToPageAndConsole(`\nè™•ç†è…”èª¿ç´šåˆ¥: ${dl.name} (è®Šæ•¸å: ${dl.varName})`, 'debug');
                if (!dl.data) {
                    logToPageAndConsole(`  ERROR: è³‡æ–™ç‰©ä»¶ (dl.data) æœªå®šç¾© for ${dl.name}. å…¨åŸŸè®Šæ•¸ ${dl.varName} å¯èƒ½æœªæ­£ç¢ºè¼‰å…¥æˆ–ä¸å­˜åœ¨ã€‚`, 'error');
                    continue;
                }
                if (!dl.data.content) {
                    logToPageAndConsole(`  ERROR: è³‡æ–™å…§å®¹ (dl.data.content) æœªå®šç¾©æˆ–ç‚ºç©º for ${dl.name}.`, 'error');
                    logToPageAndConsole(`    dl.data for ${dl.name} åŒ…å«çš„éµ: ${JSON.stringify(Object.keys(dl.data))}`, 'debug');
                    if (typeof dl.data.content === 'string') {
                         logToPageAndConsole(`    dl.data.content for ${dl.name} æ˜¯ä¸€å€‹ç©ºå­—ä¸² (é•·åº¦: ${dl.data.content.length}).`, 'debug');
                    }
                    continue;
                }
                logToPageAndConsole(`--- é–‹å§‹æª¢æŸ¥: ${dl.name} ---`, 'info');
                logToPageAndConsole(`  ${dl.name} çš„è³‡æ–™å…§å®¹ (å‰100å­—å…ƒ): "${dl.data.content.substring(0, 100)}..."`, 'debug');


                const dialectInfo = constructDialectInfo(dl.name, dl.varName);
                if (!dialectInfo) {
                    logToPageAndConsole(`  ç„¡æ³•ç‚º ${dl.name} å»ºæ§‹ dialectInfoï¼Œè·³éæ­¤é …ã€‚`, 'error');
                    continue;
                }

                let vocabularyArray;
                try {
                    vocabularyArray = csvToArray(dl.data.content);
                    logToPageAndConsole(`  ${dl.name}: csvToArray è§£æå¾Œå¾—åˆ° ${vocabularyArray.length} å€‹è©å½™é …ç›®ã€‚`, 'debug');
                    if (vocabularyArray.length > 0) {
                        logToPageAndConsole(`    é¦–å€‹è©å½™é …ç›®ç¯„ä¾‹: ${JSON.stringify(vocabularyArray[0])}`, 'debug');
                    }
                } catch (e) {
                    logToPageAndConsole(`  è§£æ ${dl.name} çš„ CSV è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${e.message}`, 'error');
                    continue;
                }

                if (vocabularyArray.length === 0) {
                    logToPageAndConsole(`  ${dl.name}: è©å½™é™£åˆ—ç‚ºç©ºï¼Œè·³éæ­¤è…”èª¿ç´šåˆ¥çš„å¾ŒçºŒé¡åˆ¥æª¢æŸ¥ã€‚`, 'info');
                    continue;
                }

                for (const category of CATEGORIES) {
                    // logToPageAndConsole(`  æª¢æŸ¥é¡åˆ¥: ${category}`, 'debug'); // é€™è¡Œè¨Šæ¯å¯èƒ½å¤ªå¤š
                    const filteredItems = vocabularyArray.filter(
                        (line) => line && line.åˆ†é¡ && line.åˆ†é¡.includes(category) 
                    );
                    // logToPageAndConsole(`    é¡åˆ¥ ${category} éæ¿¾å¾Œæœ‰ ${filteredItems.length} å€‹é …ç›®ã€‚`, 'debug');

                    if (filteredItems.length === 0) {
                        continue;
                    }

                    for (const item of filteredItems) {
                        itemsProcessed++; // å¢åŠ å·²è™•ç†é …ç›®è¨ˆæ•¸
                        const hakkaTermKey = dialectInfo.è…”å + 'å®¢å®¶èª';
                        const currentHakkaTerm = item[hakkaTermKey];

                        if (!item.ç·¨è™Ÿ || item.ç·¨è™Ÿ.trim() === '' || !currentHakkaTerm || currentHakkaTerm.trim() === '') {
                            logToPageAndConsole(`    é …ç›®è³‡æ–™ä¸å®Œæ•´ (ç¼ºå°‘æœ‰æ•ˆç·¨è™Ÿæˆ– '${hakkaTermKey}' å®¢å®¶èªè©å½™)ï¼Œè·³é: ${JSON.stringify(item).substring(0,100)}...`, 'debug');
                            continue;
                        }

                        const audioUrls = getAudioFilePaths(item, dialectInfo);
                        
                        if (audioUrls.wordAudioUrl) {
                            totalChecked++;
                            statusDiv.textContent = `ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­ (${totalChecked} å€‹éŸ³æª”)... ${dl.name} > ${category.substring(0,3)}... > ${item.ç·¨è™Ÿ}`;
                            const isWordError = await checkAndLogAudio(audioUrls.wordAudioUrl, dl.name, category, item.ç·¨è™Ÿ, currentHakkaTerm, 'è©å½™');
                            if (isWordError) totalErrors++;
                        }
                        if (audioUrls.sentenceAudioUrl) {
                            totalChecked++;
                            statusDiv.textContent = `ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­ (${totalChecked} å€‹éŸ³æª”)... ${dl.name} > ${category.substring(0,3)}... > ${item.ç·¨è™Ÿ}`;
                            const isSentenceError = await checkAndLogAudio(audioUrls.sentenceAudioUrl, dl.name, category, item.ç·¨è™Ÿ, currentHakkaTerm, 'ä¾‹å¥');
                            if (isSentenceError) totalErrors++;
                        }
                        await new Promise(resolve => setTimeout(resolve, 20)); // çŸ­æš«å»¶é²ï¼Œå¯ä»¥ç¨å¾®ç¸®çŸ­ä¸€é»é»
                    }
                }
                logToPageAndConsole(`--- ${dl.name} æª¢æŸ¥å®Œç•¢ ---`, 'info');
            }

            if (itemsProcessed === 0 && totalChecked === 0) {
                 logToPageAndConsole("è­¦å‘Šï¼šæ²’æœ‰è™•ç†ä»»ä½•è©å½™é …ç›®ï¼Œä¹Ÿæ²’æœ‰æª¢æŸ¥ä»»ä½•éŸ³æª”ã€‚\nè«‹æª¢æŸ¥ï¼š\n1. æ‰€æœ‰ .js è³‡æ–™æª”æ¡ˆæ˜¯å¦èˆ‡æ­¤ HTML æª”æ¡ˆåœ¨åŒä¸€å€‹è³‡æ–™å¤¾å…§ã€‚\n2. .js è³‡æ–™æª”æ¡ˆå…§å®¹æ˜¯å¦æ­£ç¢º (ä¾‹å¦‚ `å››åŸº.content = \"ç·¨è™Ÿ,å®¢å®¶èª,...\n...\";` é€™æ¨£çš„æ ¼å¼)ã€‚\n3. ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–éŒ¯èª¤è¨Šæ¯ã€‚", "error");
            }

            statusDiv.textContent = `ç‹€æ…‹ï¼šå…¨éƒ¨æª¢æŸ¥å®Œæˆï¼å…±è™•ç† ${itemsProcessed} å€‹è©å½™é …ç›®ï¼Œæª¢æŸ¥ ${totalChecked} å€‹éŸ³æª”ï¼Œç™¼ç¾ ${totalErrors} å€‹å•é¡ŒéŸ³æª”ã€‚`;
            startButton.disabled = false;
            logToPageAndConsole(`\nğŸ‰ å…¨éƒ¨æª¢æŸ¥å®Œæˆï¼å…±è™•ç† ${itemsProcessed} å€‹è©å½™é …ç›®ï¼Œæª¢æŸ¥ ${totalChecked} å€‹éŸ³æª”ï¼Œç™¼ç¾ ${totalErrors} å€‹å•é¡ŒéŸ³æª”ã€‚`, 'info');
        });

    </script>
</body>
</html>
